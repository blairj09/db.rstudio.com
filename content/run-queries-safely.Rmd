---
title: "Run Queries Safely"
weight: 5
---

```{r, include = FALSE, cache = FALSE}
library(odbc)
library(config)
library(DBI)

db <- config::get("mssql")

con <- DBI::dbConnect(
  odbc::odbc(),
  Driver = db$Driver,
  Server = db$Server,
  Host = db$Host,
  SVC = db$SVC,
  Database = db$Database,
  Schema = db$Schema,
  UID  = db$UID,
  PWD = db$PWD,
  Port = db$Port)

```

We will review two options to run SQL commands safely using the [DBI](/dbi/) package. The first option uses a method called **parameterized sql** and the second one uses **stored procedures**.  

The `dbGetQuery()` command allows us to write queries and retrieve the results.  The query has to be written using the SQL syntax that matches to the database type.  In this example we're using a MS SQL database, so we will use T-SQL syntax:

```{r, echo = TRUE, cache = FALSE}

dbGetQuery(con, "SELECT TOP 5 * FROM airports ")

```


## Parameterized Query

The [dplyr](/dplyr/) package is the recommended way to perform ad-hoc analyses. But in cases when we need to run the same query multiple times and each time using a different value, concatenating the SQL command using `paste0()` may be considered first.  

For times when the code is exposed to end-users, such as for interactive dashboards and apps, it is better to run a **parameterized query** using the `sqlInterpolate()` command; this will prevent a bad actor from passing a malicious value to the app this is called **SQL Injection**.

In the following example, we will use the `airport_code` variable to simulate a valued entered in an app.  The query expect one airport code passed in by the app:


```{r, echo = TRUE, cache = FALSE}
airport_code <- "GPT"
dbGetQuery(con, paste0("SELECT * FROM airports  where faa = '", airport_code ,"'"))
```

In this **SQL Injection** example we have closed the single quote and added, or injected, an additional *WHERE* statement.  This will make the database return 2 records, which is not the desired outcome.  

```{r, echo = TRUE, cache = FALSE}
airport_code <- "GPT' or faa = 'MSY"
dbGetQuery(con, paste0("SELECT * FROM airports  where faa = '", airport_code ,"'"))
```

This is a rather innocuous example; most notably, malicious SQL Injections will try to pass statements that modify the database, including deleting tables.

There are two steps to creating a **parameterized query**:

- Create a query that uses the question mark as a prefix of variables that will be passed
- Use `sqlInterpolate()`, instead of `paste0()`, inside `dbGetQuery()` and pass an argument for each variable defined in the SQL statement

This is what it looks like using current example:

```{r, echo = TRUE, cache = FALSE}
airport_code <- "GPT"
airport_sql <- "SELECT * FROM airports  where faa = ?code"
dbGetQuery(con, sqlInterpolate(con, airport_sql, code = airport_code))
```

In this case, the **SQL Injection** is unsuccessful. 

```{r, echo = TRUE, cache = FALSE}
airport_code <- "GPT' or faa = 'MSY"
airport_sql <- "SELECT * FROM airports  where faa = ?code"
dbGetQuery(con, sqlInterpolate(con, airport_sql, code = airport_code))
```

## Stored Procedures

**Stored Procedures** are scripts that reside inside the database and execute a series of steps that typically modify tables or records inside the database.  Many enterprise-grade databases support Stored Procedures.  

A common example of the use of Store Procedures is to record new business transactions that impact multiple tables. In this case, the Stored Procedure handles the creation of new keys and ensures that all of the updates are performed correctly.  

Usually, implementing Stored Procedures involves collaborating with a Database Administrator or Database Developer.  If there are Stored Procedures we are instructed to use, we can use the `EXEC` command in SQL.  

The following example calls a Stored Procedure called
[sp_stored_procedures](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-stored-procedures-transact-sql) which returns a data set containing a list of all of the Stored Procedures available in the database.

```{r, echo = TRUE, cache = FALSE}
head(dbGetQuery(con, "EXEC sp_stored_procedures"))
```

We are able to pass parameters to a Stored Procedure, similarly to how we pass an argument to an R function.  Here is the spec from taken from the [MS SQL page](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-stored-procedures-transact-sql): 

```
sp_stored_procedures [ [ @sp_name = ] 'name' ]   
    [ , [ @sp_owner = ] 'schema']   
    [ , [ @sp_qualifier = ] 'qualifier' ]  
    [ , [@fUsePattern = ] 'fUsePattern' ]  
```

```{r}
head(dbGetQuery(con, "EXEC sp_stored_procedures @sp_owner = 'sys'"))
```

The main goal of this Stored Procedure is to retrieve data.  If we run one that aims at making updates to the database we would then run it as a SQL transaction

```{r, eval = FALSE}
dbBegin(con)
dbExecute(con, "EXEC sp_stored_procedures @sp_owner = 'sys'")
dbCommit(con)
```






