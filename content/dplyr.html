---
title: "Databases & dplyr"
weight: 4

---


<p>After connecting R to a database, we have to tackle the challenge manipulating data using two languages, R and SQL.</p>
<p>The <strong>dplyr</strong> package simplifies data wrangling of in-memory data in R, and is also able to do this with remote databases when used in combination with the <strong>dbplyr</strong> package.</p>
<p>In the background, the <em>dbplyr</em> package translates the <em>dplyr</em> commands into <em>SQL</em> commands, thus allowing us to start and end a data analysis using R code only!</p>
<p>The main goal should be to push as much of the aggregating and filtering to the database and to bring back as little data as possible into R memory.</p>
<p>If new to dplyr, please start by reviewing package’s official site: <a href="http://dplyr.tidyverse.org/" class="uri">http://dplyr.tidyverse.org/</a></p>
<div id="package-installation" class="section level2">
<h2>Package installation</h2>
<p>We will start by installing both packages from <strong>CRAN</strong>:</p>
<pre class="r"><code># The install commands will be replaced when both packages are up-to-date in CRAN
devtools::install_github(&quot;hadley/dbplyr&quot;)
devtools::install_github(&quot;tidyverse/dplyr&quot;)</code></pre>
</div>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>We have pre-loaded the <em>flights</em>, <em>airlines</em> and <em>airports</em> datasets from the <em>nycflights13</em> package into tables inside a Microsoft SQL database. The <em>Connections</em> pane in the <strong>RStudio IDE</strong> shows the tables currently available in the database:</p>
<p><br/></p>
<div class="figure">
<img src="conn-pane.png" />

</div>
</div>
<div id="referencing-tables" class="section level2">
<h2>Referencing tables</h2>
<p>The simplest way to preview a table with <em>dplyr</em> is by using the <code>tbl()</code> command.</p>
<pre class="r"><code>library(dplyr)
library(dbplyr)

tbl(con, &quot;flights&quot;)</code></pre>
<pre><code>## Source:     table&lt;flights&gt; [?? x 19]
## Database:   Microsoft SQL Server 12.00.4422[rstudioadmin@EC2AMAZ-O5QKKM8/airontime]
## 
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
## 1   2013     1     1      517            515         2      830
## 2   2013     1     1      533            529         4      850
## 3   2013     1     1      542            540         2      923
## 4   2013     1     1      544            545        -1     1004
## 5   2013     1     1      554            600        -6      812
## 6   2013     1     1      554            558        -4      740
## 7   2013     1     1      555            600        -5      913
## 8   2013     1     1      557            600        -3      709
## 9   2013     1     1      557            600        -3      838
## 10  2013     1     1      558            600        -2      753
## # ... with more rows, and 12 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<p>The table preview’s header also displays information about the database, such as <em>type</em>, <em>version</em>, <em>server name</em>, <em>user ID</em> and <em>database name</em>.</p>
</div>
<div id="laziness" class="section level2">
<h2>‘Laziness’</h2>
<p>Notice that the following command does not return an output. The <code>flights_count</code> variable is not a data frame in our environment.</p>
<pre class="r"><code>flights_count &lt;- tally(tbl(con, &quot;flights&quot;))</code></pre>
<p>The resulting SQL statement will not be executed until we ask R to do something with the variable, which is why is called ‘lazy’. Because calling the variable inside the R Markdown code chunk triggers a ‘preview’ of the variable, is up until this point that the query is executed.</p>
<pre class="r"><code>flights_count</code></pre>
<pre><code>## Source:     lazy query [?? x 1]
## Database:   Microsoft SQL Server 12.00.4422[rstudioadmin@EC2AMAZ-O5QKKM8/airontime]
## 
##        n
##    &lt;int&gt;
## 1 336776</code></pre>
</div>
<div id="resulting-sql" class="section level2">
<h2>Resulting SQL</h2>
<p>To take a look behind the scenes, we can use the <code>show_query()</code> command to see what is the SQL statement that <em>dplyr</em> will execute. This is not something that we will do on a regular basis, but we are including it in this example to provide an idea what the packages are doing.</p>
<pre class="r"><code>show_query(flights_count)</code></pre>
<pre><code>## &lt;SQL&gt;
## SELECT COUNT(*) AS &quot;n&quot;
## FROM &quot;flights&quot;</code></pre>
</div>
<div id="grouping-data-commands" class="section level2">
<h2>Grouping data &amp; commands</h2>
<p>We can group multiple commands connected with what we call <em>pipes</em>, which look like this <code>%&gt;%</code>. For our purposes, the SQL statement will be built based on how we sequence specific dplyr commands. The package that does this is called <a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html">magrittr</a>, and it is automatically loaded when we call the dplyr library.</p>
<p>To group data, we use dplyr’s <code>group_by()</code> command, which allows us to group one or more fields.</p>
<p>The following code retrieves the <em>total number of flights by carrier</em>. We start with the <em>flights</em> table by using <code>tbl()</code>, then <code>group_by()</code> the <code>carrier</code> field, and get the record count using <code>tally()</code>. The SQL translation will more likely not be sequenced in the same way, but that’s taken cared of by the translation inside <em>dbplyr</em>.</p>
<pre class="r"><code>tbl(con, &quot;flights&quot;) %&gt;%
  group_by(carrier) %&gt;%
  tally</code></pre>
<pre><code>## Source:     lazy query [?? x 2]
## Database:   Microsoft SQL Server 12.00.4422[rstudioadmin@EC2AMAZ-O5QKKM8/airontime]
## 
##    carrier     n
##      &lt;chr&gt; &lt;int&gt;
## 1       DL 48110
## 2       AS   714
## 3       MQ 26397
## 4       US 20536
## 5       B6 54635
## 6       F9   685
## 7       UA 58665
## 8       VX  5162
## 9       OO    32
## 10      AA 32729
## # ... with more rows</code></pre>
</div>
<div id="joining-tables" class="section level2">
<h2>Joining tables</h2>
<p>Combining different datasets is a common practice in data analysis, and the way dplyr helps us with this is by providing <em>join</em> commands that combines two data sets. Just like in SQL, dplyr provides multiple types of joins: <code>inner_join()</code>, <code>left_join()</code>, <code>full_join()</code>, <code>right_join()</code>. RStudio has authored a <a href="https://github.com/rstudio/cheatsheets/raw/master/source/pdfs/data-transformation-cheatsheet.pdf">Cheatsheet</a> which includes a section that makes it easier to visualize how the joins work.</p>
<p>We will join the <em>airlines</em> table with the <em>flights</em> table so we can get the actual name of the airline instead of the code:</p>
<pre class="r"><code>tbl(con, &quot;flights&quot;) %&gt;%
  left_join(tbl(con, &quot;airlines&quot;), by = &quot;carrier&quot;) %&gt;%
  group_by(name) %&gt;%
  tally %&gt;%
  arrange(desc(n))</code></pre>
<pre><code>## Source:     lazy query [?? x 2]
## Database:   Microsoft SQL Server 12.00.4422[rstudioadmin@EC2AMAZ-O5QKKM8/airontime]
## Ordered by: desc(n)
## 
##                        name     n
##                       &lt;chr&gt; &lt;int&gt;
## 1     United Air Lines Inc. 58665
## 2           JetBlue Airways 54635
## 3  ExpressJet Airlines Inc. 54173
## 4      Delta Air Lines Inc. 48110
## 5    American Airlines Inc. 32729
## 6                 Envoy Air 26397
## 7           US Airways Inc. 20536
## 8         Endeavor Air Inc. 18460
## 9    Southwest Airlines Co. 12275
## 10           Virgin America  5162
## # ... with more rows</code></pre>
</div>
<div id="retrieve-results" class="section level2">
<h2>Retrieve results</h2>
<p>As mentioned at the top of this page, our main goal should be to push as much as much of the data wrangling to the database and to retrieve into R as small data as possible, like summarized results. To retrieve the results from the database, we will use the <code>collect</code> command:</p>
<pre class="r"><code>carrier_totals &lt;- tbl(con, &quot;flights&quot;) %&gt;%
  left_join(tbl(con, &quot;airlines&quot;), by = &quot;carrier&quot;) %&gt;%
  group_by(name) %&gt;%
  tally %&gt;%
  arrange(desc(n)) %&gt;%
  collect

head(carrier_totals)</code></pre>
<pre><code>## # A tibble: 6 × 2
##                       name     n
##                      &lt;chr&gt; &lt;int&gt;
## 1    United Air Lines Inc. 58665
## 2          JetBlue Airways 54635
## 3 ExpressJet Airlines Inc. 54173
## 4     Delta Air Lines Inc. 48110
## 5   American Airlines Inc. 32729
## 6                Envoy Air 26397</code></pre>
<p>After running the code above, we finally have our first dataframe loaded to our R environment. All of the data transformations on top of the over 300K records happened in the database, and we brought back only 16 records into memory.</p>
</div>
<div id="visualization" class="section level2">
<h2>Visualization</h2>
<p>The preferred approach for visualization is to perform the aggregations inside the database and bring the results back into R for visualization. Here will use the <em>ggplot2</em> package to visualize the <code>carrier_totals</code> data frame:</p>
<pre class="r"><code>library(ggplot2)

ggplot(data = carrier_totals) +
  geom_bar(aes(x = reorder(name, n), y = n), stat = &quot;identity&quot;) +
  coord_flip()</code></pre>
<p><img src="/dplyr_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="learn-more" class="section level2">
<h2>Learn more</h2>
<p>There are more data transformation verbs in <em>dplyr</em> than the ones covered in this page:</p>
<ul>
<li><code>mutate()</code> adds new variables that are functions of existing variables</li>
<li><code>select()</code> picks variables based on their names.</li>
<li><code>filter()</code> picks cases based on their values.</li>
<li><code>arrange()</code> changes the ordering of the rows.</li>
</ul>
<p>The <a href="http://r4ds.had.co.nz/transform.html">R for Data Science</a> book and the <a href="https://github.com/rstudio/cheatsheets/raw/master/source/pdfs/data-transformation-cheatsheet.pdf">Data Transformation Cheatsheet</a> are two great resources to dive deeper into <em>dplyr</em>.</p>
</div>
