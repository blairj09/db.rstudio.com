---
title: "Interact with databases using DBI"
weight: 5
---

<!-- BLOGDOWN-HEAD -->
<!-- /BLOGDOWN-HEAD -->

<!-- BLOGDOWN-BODY-BEFORE -->
<!-- /BLOGDOWN-BODY-BEFORE -->
<div id="when-to-use" class="section level2">
<h2>When to use</h2>
<p>The <a href="http://rstats-db.github.io/DBI/">DBI</a> package provides an interface between R and databases; it separates the operations that run against the database from the functions that are exposed to the user and other applications. By doing this, the same R commands can be used to perform the same operations over a variety of databases.</p>
<p>We recommend using <a href="/dplyr/">dplyr</a> for day-to-day data preparation and tidying. The <a href="http://rstats-db.github.io/DBI/">DBI</a> package is a great tool to help with the rest of database-related tasks such as the following:</p>
<ul>
<li>Connecting to and disconnecting from a database</li>
<li>Retrieving the list of tables and fields</li>
<li>Adding or removing tables</li>
<li>Writing data back to a table</li>
<li>Running recurring queries</li>
<li>Executing stored procedures (if supported)</li>
</ul>
<p>The <a href="https://cran.r-project.org/web/packages/DBI/vignettes/spec.html">DBI: R Database Interface</a> provides a comprehensive review of how DBI works.</p>
</div>
<div id="connecting-to-a-database" class="section level2">
<h2>Connecting to a Database</h2>
<p>When using the Connections interface, The RStudio IDE generates an R code snippet that connects to the database (see <a href="/connect/">Connect to a Database</a>).</p>
<p><BR/></p>
<div class="figure">
<img src="conn-setup.png" />

</div>
<p>The connection snippet uses DBI’s <code>dbConnect()</code> command to open the connection. This is the command where we specify the driver, user, password, database name, and other arguments needed to properly start a session with the database. Conversely, <code>dbDisconnect()</code> will close the connection.</p>
</div>
<div id="tables-fields" class="section level2">
<h2>Tables &amp; Fields</h2>
<p>If you are using the RStudio IDE, then exploring an open database connection is as easy as expanding and drilling down into the schema using the Connections tab.</p>
<p>Using code, to get a list of the tables in an existing database connection, use <code>dbListTables()</code></p>
<pre class="r"><code>dbListTables(con)</code></pre>
<pre><code>## [1] &quot;airlines&quot; &quot;airport&quot;  &quot;airports&quot; &quot;faithful&quot; &quot;flights&quot;  &quot;iris&quot;</code></pre>
<p>For a list of the fields in a particular table inside the database connection use <code>dbListFields()</code></p>
<pre class="r"><code>dbListFields(con, &quot;flights&quot;)</code></pre>
<pre><code>##  [1] &quot;year&quot;           &quot;month&quot;          &quot;day&quot;            &quot;dep_time&quot;      
##  [5] &quot;sched_dep_time&quot; &quot;dep_delay&quot;      &quot;arr_time&quot;       &quot;sched_arr_time&quot;
##  [9] &quot;arr_delay&quot;      &quot;carrier&quot;        &quot;flight&quot;         &quot;tailnum&quot;       
## [13] &quot;origin&quot;         &quot;dest&quot;           &quot;air_time&quot;       &quot;distance&quot;      
## [17] &quot;hour&quot;           &quot;minute&quot;         &quot;time_hour&quot;</code></pre>
</div>
<div id="adding-and-removing-tables" class="section level2">
<h2>Adding and Removing Tables</h2>
<p>The <code>dbWriteTable()</code> and <code>dbRemoveTable()</code> can be used to perform their respective operations. The user will need to have the proper database rights to be able to run these operations.</p>
<p>A data frame can be passed to <code>dbWriteTable()</code> to create and simultaneously populate the table:</p>
<pre class="r"><code>library(nycflights13)
dbWriteTable(con, &quot;flights&quot;, flights)</code></pre>
</div>
<div id="run-queries-safely" class="section level2">
<h2>Run Queries Safely</h2>
<p>In this section we will review two options to run SQL commands safely; the first uses a method called <strong>parameterized sql</strong> and the second uses <strong>stored procedures</strong>.</p>
<p>The <code>dbGetQuery()</code> allows us to write queries and retrieve the results. The query has to be written using the SQL syntax that matches to the database type. In this example, since we’re using a MS SQL database, we will use T-SQL syntax:</p>
<pre class="r"><code>dbGetQuery(con, &quot;SELECT TOP 5 * FROM airports &quot;)</code></pre>
<pre><code>##   faa                          name      lat       lon  alt tz dst
## 1 04G             Lansdowne Airport 41.13047 -80.61958 1044 -5   A
## 2 06A Moton Field Municipal Airport 32.46057 -85.68003  264 -5   A
## 3 06C           Schaumburg Regional 41.98934 -88.10124  801 -6   A
## 4 06N               Randall Airport 41.43191 -74.39156  523 -5   A
## 5 09J         Jekyll Island Airport 31.07447 -81.42778   11 -4   A</code></pre>
<p>As mentioned at the top of this page, <a href="/dplyr/">dplyr</a> is the recommended way to perform ad-hoc analytics. But in cases when we need to run the same query multiple times but each time using a different value, concatenating the SQL command using <code>paste0()</code> may be considered first.</p>
<p>For times when the code is exposed to end-users, such as for interactive dashboards and apps, it is better to run a <strong>parameterized query</strong> using the <code>sqlInterpolate()</code> command; this will prevent a bad actor from passing a malicious value to the app this is called <strong>SQL Injection</strong>.</p>
<p>In the following example, we will use the <code>airport_code</code> variable to simulate a valued entered in an app. The query expect one airport code passed in by the app:</p>
<pre class="r"><code>airport_code &lt;- &quot;GPT&quot;
dbGetQuery(con, paste0(&quot;SELECT * FROM airports  where faa = &#39;&quot;, airport_code ,&quot;&#39;&quot;))</code></pre>
<pre><code>##   faa            name      lat       lon alt tz dst
## 1 GPT Gulfport-Biloxi 30.40728 -89.07011  28 -6   A</code></pre>
<p>In this <strong>SQL Injection</strong> example we have closed the single quote and added, or injected, an additional <em>WHERE</em> statement. This will make the database return 2 records, which is not the desired outcome.</p>
<pre class="r"><code>airport_code &lt;- &quot;GPT&#39; or faa = &#39;MSY&quot;
dbGetQuery(con, paste0(&quot;SELECT * FROM airports  where faa = &#39;&quot;, airport_code ,&quot;&#39;&quot;))</code></pre>
<pre><code>##   faa                             name      lat       lon alt tz dst
## 1 GPT                  Gulfport-Biloxi 30.40728 -89.07011  28 -6   A
## 2 MSY Louis Armstrong New Orleans Intl 29.99339 -90.25803   4 -6   A</code></pre>
<p>This is a rather innocuous example; most notably, malicious SQL Injections will try to pass statements that modify the database, including completely deleting tables.</p>
<p>There are two steps to creating a <strong>parameterized query</strong>:</p>
<ul>
<li>Create a query that uses the question mark as a prefix of variables that will be passed</li>
<li>Use <code>sqlInterpolate()</code>, instead of <code>paste0()</code>, inside <code>dbGetQuery()</code> and pass an argument for each variable defined in the SQL statement</li>
</ul>
<p>This is what it looks like using current example:</p>
<pre class="r"><code>airport_code &lt;- &quot;GPT&quot;
airport_sql &lt;- &quot;SELECT * FROM airports  where faa = ?code&quot;
dbGetQuery(con, sqlInterpolate(con, airport_sql, code = airport_code))</code></pre>
<pre><code>##   faa            name      lat       lon alt tz dst
## 1 GPT Gulfport-Biloxi 30.40728 -89.07011  28 -6   A</code></pre>
<p>In this case, the <strong>SQL Injection</strong> is unsuccessful.</p>
<pre class="r"><code>airport_code &lt;- &quot;GPT&#39; or faa = &#39;MSY&quot;
airport_sql &lt;- &quot;SELECT * FROM airports  where faa = ?code&quot;
dbGetQuery(con, sqlInterpolate(con, airport_sql, code = airport_code))</code></pre>
<pre><code>## [1] faa  name lat  lon  alt  tz   dst 
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<div id="stored-procedures" class="section level3">
<h3>Stored Procedures</h3>
<p><strong>Stored Procedures</strong> are scripts that reside inside the database and execute a series of steps that typically modify tables or records inside the database; many enterprise-grade databases support them.</p>
<p>A common use of Store Procedures is to record new business transactions records that impact multiple tables. In this case, the Stored Procedure handles the creation of new keys and ensures that all of the updates are performed correctly.<br />
Usually, implementing Stored Procedures involves collaborating with a Database Administrator or Database Developer. If there are Stored Procedures we are instructed to use, we can use the <code>EXEC</code> command in SQL. The following example calls a Stored Procedure called <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-stored-procedures-transact-sql">sp_stored_procedures</a> which returns a data set containing a list of all of the Stored Procedures available in the database.</p>
<pre class="r"><code>head(dbGetQuery(con, &quot;EXEC sp_stored_procedures&quot;))</code></pre>
<pre><code>##   PROCEDURE_QUALIFIER PROCEDURE_OWNER
## 1           airontime             sys
## 2           airontime             sys
## 3           airontime             sys
## 4           airontime             sys
## 5           airontime             sys
## 6           airontime             sys
##                           PROCEDURE_NAME NUM_INPUT_PARAMS
## 1 dm_cryptographic_provider_algorithms;0               -1
## 2       dm_cryptographic_provider_keys;0               -1
## 3   dm_cryptographic_provider_sessions;0               -1
## 4      dm_db_database_page_allocations;0               -1
## 5        dm_db_index_operational_stats;0               -1
## 6           dm_db_index_physical_stats;0               -1
##   NUM_OUTPUT_PARAMS NUM_RESULT_SETS REMARKS PROCEDURE_TYPE
## 1                -1              -1    &lt;NA&gt;              2
## 2                -1              -1    &lt;NA&gt;              2
## 3                -1              -1    &lt;NA&gt;              2
## 4                -1              -1    &lt;NA&gt;              2
## 5                -1              -1    &lt;NA&gt;              2
## 6                -1              -1    &lt;NA&gt;              2</code></pre>
<p>We are able to pass parameters to a Stored Procedure, similarly to how we pass an argument to an R function. Here is the spec from taken from the <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-stored-procedures-transact-sql">MS SQL page</a>:</p>
<pre><code>sp_stored_procedures [ [ @sp_name = ] &#39;name&#39; ]   
    [ , [ @sp_owner = ] &#39;schema&#39;]   
    [ , [ @sp_qualifier = ] &#39;qualifier&#39; ]  
    [ , [@fUsePattern = ] &#39;fUsePattern&#39; ]  </code></pre>
<pre class="r"><code>head(dbGetQuery(con, &quot;EXEC sp_stored_procedures @sp_owner = &#39;sys&#39;&quot;))</code></pre>
<pre><code>##   PROCEDURE_QUALIFIER PROCEDURE_OWNER
## 1           airontime             sys
## 2           airontime             sys
## 3           airontime             sys
## 4           airontime             sys
## 5           airontime             sys
## 6           airontime             sys
##                           PROCEDURE_NAME NUM_INPUT_PARAMS
## 1 dm_cryptographic_provider_algorithms;0               -1
## 2       dm_cryptographic_provider_keys;0               -1
## 3   dm_cryptographic_provider_sessions;0               -1
## 4      dm_db_database_page_allocations;0               -1
## 5        dm_db_index_operational_stats;0               -1
## 6           dm_db_index_physical_stats;0               -1
##   NUM_OUTPUT_PARAMS NUM_RESULT_SETS REMARKS PROCEDURE_TYPE
## 1                -1              -1    &lt;NA&gt;              2
## 2                -1              -1    &lt;NA&gt;              2
## 3                -1              -1    &lt;NA&gt;              2
## 4                -1              -1    &lt;NA&gt;              2
## 5                -1              -1    &lt;NA&gt;              2
## 6                -1              -1    &lt;NA&gt;              2</code></pre>
<p>The main goal of this Stored Procedure is to retrieve data. If we run one that aims at making updates to the database we would then run it as a SQL transaction</p>
<pre class="r"><code>dbBegin(con)
dbExecute(con, &quot;EXEC sp_stored_procedures @sp_owner = &#39;sys&#39;&quot;)
dbCommit(con)</code></pre>
</div>
</div>
