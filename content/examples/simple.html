---
title: Using Databases in R
output: 
  html_document
---

<!-- BLOGDOWN-HEAD -->
<!-- /BLOGDOWN-HEAD -->

<!-- BLOGDOWN-BODY-BEFORE -->
<!-- /BLOGDOWN-BODY-BEFORE -->
<div id="initial-setup" class="section level1">
<h1>Initial Setup</h1>
<div id="install-rstudios-odbc-drivers" class="section level2">
<h2>Install RStudio’s ODBC drivers</h2>
<p>The <a href="https://github.com/rstudio/odbc-install">odbc-install</a> repository has a script that simplifies the installation of the ODBC drivers in the client machine.</p>
<div id="red-hat-enterprise-linuxcentos-linux-6.0" class="section level3">
<h3>Red Hat Enterprise Linux/CentOS Linux (6.0+)</h3>
<p>There are two system dependencies that need to be installed prior to installing the drivers</p>
<pre class="bash"><code>sudo yum install wget
sudo yum install unixODBC</code></pre>
<p>The following script will download and install the drivers:</p>
<pre class="bash"><code># Placeholder path
wget -O - https://s3-us-west-2.amazonaws.com/rstudio-odbc/...</code></pre>
</div>
</div>
<div id="securing-credentials-using-the-keyring-package" class="section level2">
<h2>Securing Credentials using the keyring package</h2>
<p>The <a href="https://github.com/gaborcsardi/keyring">keyring</a> package enables us to access the operating system’s credential store.</p>
<pre class="r"><code>devtools::install_github(&quot;gaborcsardi/keyring&quot;)</code></pre>
<p>In this example, we will create a new key ring called <em>rstudio.odbc</em> and add a single key with the server path and credentials. Additional servers can be added to the same key ring by adding additional keys.</p>
<p>The way <strong>keyring</strong> retrieves data is by passing the Key Ring name and a <strong>service</strong> name. In this method, we will use the server path as the <strong>service</strong> so it will act as our key to retrieve user name and password to use for that particular server.</p>
<p>To prevent passing the server path in our code, we will use another package called <strong>config</strong>, which is discussed in the next section.</p>
<pre class="r"><code>keyring::keyring_create(&quot;rstudio.odbc&quot;)

keyring::key_set_with_value(service = &quot;sol-eng-sqlserv.cihykudhzbgw.us-west-2.rds.amazonaws.com&quot;, 
                            username = &quot;rstudioadmin&quot;, 
                            password = &quot;ABCd4321&quot;, 
                            keyring = &quot;rstudio.odbc&quot;)</code></pre>
</div>
<div id="simplify-connections-using-the-config-package" class="section level2">
<h2>Simplify connections using the config package</h2>
<p>The <a href="https://github.com/rstudio/config">config</a> package simplifies management of environment specific configuration values.</p>
<pre class="r"><code>devtools::install_github(&quot;rstudio/config&quot;)</code></pre>
<p>The values are saved in a YAML file called <strong>config.yml</strong>. The package also allows R code to be used as values, we will use this capability to retrieve the credentials from Key Ring.</p>
<p>This is the YAML file used for this exercise:</p>
<pre><code>  default:
    datawarehouse: 
      server: &quot;sol-eng-sqlserv.cihykudhzbgw.us-west-2.rds.amazonaws.com&quot;
      uid: !expr keyring::key_list(&quot;sol-eng-sqlserv.cihykudhzbgw.us-west-2.rds.amazonaws.com&quot;,  
           keyring = &quot;rstudio.odbc&quot;)[1,2]
      pwd: !expr keyring::key_get(&quot;sol-eng-sqlserv.cihykudhzbgw.us-west-2.rds.amazonaws.com&quot;,  
           keyring = &quot;rstudio.odbc&quot;)
      database: &quot;airontime&quot;</code></pre>
</div>
</div>
<div id="using-databases-for-analysis" class="section level1">
<h1>Using Databases for analysis</h1>
<div id="connecting-to-a-database-using-the-odbc-package" class="section level2">
<h2>Connecting to a Database using the odbc package</h2>
<p>The <a href="https://github.com/rstats-db/odbc">odbc</a> package provides a DBI-compliant interface to ODBC drivers. Drivers to a wide assortment of database types are provided as part of RStudio’s commercial products.</p>
<p><strong>Why is a DBI compliant interface important? </strong> Apart from enabling the analyst to leverage <a href="http://rstats-db.github.io/DBI/">DBI</a> for their analysis, it also opens the door for a <a href="https://github.com/tidyverse/dplyr">dplyr</a> back end to be developed which makes data wrangling transparent to the analysts since they can continue using the same <em>dplyr</em> commands.</p>
<pre class="r"><code>devtools::install_github(&quot;rstats-db/odbc&quot;)</code></pre>
<p>Use <strong>dbConnect</strong> to access the database. Passing the values from the <strong>config</strong> file enables us to protect the credentials and abstracts the server and database name in case we need to promote the code to point from a test to a production database.</p>
<pre class="r"><code>library(odbc)
library(config)
library(DBI)

con &lt;- dbConnect(odbc::odbc(), 
  .connection_string = paste0(&quot;Driver={sqlserver};
                              Server=&quot;, config::get(&quot;datawarehouse&quot;)$server ,&quot;;
                              Port=1433;
                              Database=&quot;, config::get(&quot;datawarehouse&quot;)$database ,&quot;;
                              UID=&quot;, config::get(&quot;datawarehouse&quot;)$uid ,&quot;;
                              PWD=&quot;, config::get(&quot;datawarehouse&quot;)$pwd ,&quot;;&quot;))</code></pre>
</div>
<div id="interacting-with-the-database-using-dbi" class="section level2">
<h2>Interacting with the database using DBI</h2>
<p>Here are a few basic DBI commands that can be used to access the database.</p>
<div id="list-tables" class="section level3">
<h3>List tables</h3>
<pre class="r"><code>dbListTables(con)</code></pre>
</div>
<div id="list-fields" class="section level3">
<h3>List Fields</h3>
<pre class="r"><code>dbListFields(con, &quot;mtcars&quot;)</code></pre>
</div>
<div id="run-a-query" class="section level3">
<h3>Run a query</h3>
<p>Using the appropriate SQL syntax for the type of connection, you can use the <strong>dbGetQuery</strong> run queries.</p>
<pre class="r"><code>dbGetQuery(con, &quot;SELECT row_names, mpg, cyl FROM mtcars WHERE mpg &gt; 25 ORDER BY row_names&quot;)</code></pre>
</div>
</div>
<div id="analyzing-data-using-dplyr" class="section level2">
<h2>Analyzing data using dplyr</h2>
<div id="install-dbplyr" class="section level3">
<h3>Install dbplyr</h3>
<p>The new <a href="https://github.com/hadley/dbplyr">dbplyr</a> package has all of <em>dplyr</em>’s code related to databases, including the code that translates dplyr commands into vendor specific SQL commands. This separation will make it easier to release fixes for bugs that relate to database management.</p>
<pre class="r"><code>devtools::install_github(&quot;hadley/dbplyr&quot;)</code></pre>
</div>
<div id="using-dplyr" class="section level3">
<h3>Using dplyr</h3>
<pre class="r"><code>library(dplyr)
library(dbplyr)

mssql_mtcars &lt;- tbl(con, &quot;mtcars&quot;)

mssql_mtcars</code></pre>
<pre class="r"><code>mssql_mtcars %&gt;%
  select(row_names, mpg, cyl) %&gt;%
  filter(mpg &gt; 25) %&gt;%
  arrange(row_names)</code></pre>
</div>
<div id="disconnect" class="section level3">
<h3>Disconnect</h3>
<pre class="r"><code>dbDisconnect(con)</code></pre>
</div>
</div>
</div>
